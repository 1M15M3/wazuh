---
test_name: DELETE /agents

stages:
  - name: Remove not exist agents

    request: &test_request
      url: http://localhost:55000/agents
      method: DELETE
      params:
        list_agents: 007,006

    response: &test_response
      status_code: 200
      body:
        error: 0
        data:
          affected_agents: []
          failed_ids:
            - error:
                code: 1701
                message: "Agent does not exist: 007"
              id: '007'
            - error:
                code: 1701
                message: "Agent does not exist: 006"
              id: '006'
          msg: Some agents were not removed
          older_than: 7d
          total_affected_agents: 0
          total_failed_ids: 2

  - name: Create an agent to delete

    request:
      url: http://localhost:55000/agents/newAgent
      method: PUT

    response:
      status_code: 200
      body:
        error: 0
        data:
          id: '003'
          key: !anystr
    
    delay_after: 11

  - name: Remove an agent

    request:
      url: http://localhost:55000/agents
      method: DELETE
      params:
        list_agents: '003'
        older_than: '10s'
        purge: True

    response:
      status_code: 200
      body:
        error: 0
        data:
          affected_agents: ["003"]
          msg: All selected agents were removed
          older_than: 10s
          total_affected_agents: 1

---
test_name: Get all agent

stages:
  - name: Get all agent

    request:
      url: &url http://localhost:55000/agents
      method: &metodo GET
      params:
        limit: 2

    response:
      status_code: 200
      body:
        error: 0

---
test_name: GET /agents/summary

stages:
  - name: Get agents summary

    request:
      url: http://localhost:55000/agents/summary
      method: GET
      params:
        limit: 2

    response:
      status_code: 200
      body:
        error: 0
        data:
          Total: !anyint
          Active: !anyint
          Disconnected: !anyint
          Never connected: !anyint
          Pending: !anyint

---
test_name: GET /agents/outdated

stages:
  - name: Get outdated agents

    request:
      url: http://localhost:55000/agents/outdated
      method: GET
      params:
        limit: 2

    response:
      status_code: 200
      body:
        error: 0
        data:
          items: !anything
          totalItems: !anyint

---
test_name: GET /agents/:agent_id

stages:

  - name: Get an agent

    request: &get_agent
      url: http://localhost:55000/agents/001
      method: GET

    response: &agent_response
      status_code: 200
      body:
        error: 0
        data:
          dateAdd: !anystr
          id: "001"
          ip: !anystr
          lastKeepAlive: !anystr
          manager: !anystr
          name: !anystr
          node_name: !anystr
          os:
            arch: !anystr
            codename: !anystr
            major: !anystr
            minor: !anystr
            name: !anystr
            platform: !anystr
            uname: !anystr
            version: !anystr
          registerIP: !anystr
          status: !anystr
          version: !anystr

  - name: Get manager

    request:
      url: http://localhost:55000/agents/000
      method: GET

    response: 
      <<: *agent_response
      body:
        data:
          id: "000"

  - name: Get an agent with some select

    request: 
      <<: *get_agent
      params:
        select: dateAdd,mergedSum

    response: 
      status_code: 200
      body:
        error: 0
        data:
          dateAdd: !anystr
          mergedSum: !anystr
  
  - name: Get an agent, not allowed selector

    request: 
      <<: *get_agent
      params:
        select: wrongParam

    response:
      status_code: 200
      body:
        error: 1724
        message: !anystr
  
  - name: Get an agent, bad id

    request:
      url: http://localhost:55000/agents/abc
      method: GET

    response:
      status_code: 400

  - name: Get an agent, not agent

    request:
      url: http://localhost:55000/agents/99999
      method: GET

    response:
      status_code: 200
      body:
        error: 1701
        message: !anystr
  
  - name: Get manager, with some select

    request:
      url: http://localhost:55000/agents/000
      method: GET

    response:
      status_code: 200
      body:
        error: 0
        data:
          id: !anystr
          ip: !anystr
          lastKeepAlive: !anystr
          status: !anystr

  - name: Get manager wrong field

    request: 
      url: http://localhost:55000/agents/000
      method: GET
      params:
        select: wrongParam

    response:
      status_code: 200
      body:
        error: 1724
        message: !anystr

---
test_name: GET /agents/name/:agent_name

stages:
  - name: Create an agent to delete

    request:
      url: http://localhost:55000/agents/common_agent
      method: PUT

    response:
      status_code: 200
      body:
        error: 0
        data:
          id: !anystr
          key: !anystr

  - name: Get agent by name

    request:
      url: http://localhost:55000/agents/name/common_agent
      method: GET

    response:
      status_code: 200
      body:
        error: 0
        data:
          dateAdd: !anystr
          id: !anystr
          ip: !anystr
          name: !anystr
          node_name: !anystr
          registerIP: !anystr
          status: !anystr


  - name: Get key with not exit agent

    request:
      url: http://localhost:55000/agents/name/not_exist_agent
      method: GET

    response:
      status_code: 200
      body:
        error: 1701
        message: !anystr

  - name: Get agent by name

    request:
      url: http://localhost:55000/agents/name/common_agent
      method: GET
      params:
        select: dateAdd,mergedSum,os.name

    response: 
      status_code: 200
      body:
        error: 0
        data:
          dateAdd: !anystr
          #mergedSum: !anystr
          #os:
            #name: !anystr

---
test_name: GET /agents/:agent_id/key

stages:
  - name: Get agent key

    request:
      url: http://localhost:55000/agents/001/key
      method: GET

    response:
      status_code: 200
      body:
        error: 0
        data: !anystr

  - name: Get key with bad agent id

    request:
      url: http://localhost:55000/agents/abc/key
      method: GET

    response:
      status_code: 400

  - name: Get key with not exit agent

    request:
      url: http://localhost:55000/agents/99999/key
      method: GET

    response:
      status_code: 200
      body:
        error: 1701
        message: !anystr


#Distributed request
---
test_name: PUT /agents/restart

stages:
  - name: Restart all agents

    request:
      url: http://localhost:55000/agents/restart
      method: PUT

    response:
      status_code: 200 
      body:
        error: 0
        data: Restarting all agents